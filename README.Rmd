---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "70%"
)
set.seed(843)
```

# `tidyfast v0.1.2` <img src=".graphics/tidyfast_hex.png" align="right" width="30%" height="30%" />

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

The goal of `tidyfast` is to provide fast and efficient alternatives to some `tidyr` and `dplyr` functions using `data.table` under the hood. Each have the prefix of `dt_` to allow for autocomplete in IDEs such as RStudio. These should compliment some of the current functionality in `dtplyr` (but notably does not use the `lazy_dt()` framework of `dtplyr`).

The current functions include:

**Nesting and unnesting** (similar to `tidyr::nest()` or `dplyr::group_nest()` and `tidyr::unnest()`):

- `dt_nest()` for nesting data tables
- `dt_unnest()` for unnesting data tables
- `dt_unnest_vec()` for unnesting vectors in a list-column in a data table

**If Else** (similar to `dplyr::case_when()`):

- `dt_case_when()` for `dplyr::case_when()` syntax with the speed of `data.table::fifelse()`

**Fill** (similar to `tidyr::fill()`)

- `dt_fill()` for filling `NA` values with values before it, after it, or both. This can be done by a grouping variable (e.g. fill in `NA` values with values within an individual).

**Separate** (similar to `tidyr::separate()`)

- `dt_separate()` for splitting a single column into multiple based on a match within the column (e.g., column with "A.B" could be split into two columns by using the period as the separator). It is built on `data.table::tstrsplit()`. This is not well tested yet and lacks some functionality of `tidyr::separate()`.



Package is still in active development.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("TysonStanley/tidyfast")
```

## Examples

### Nesting and Unnesting

The nesting and unnesting functions were shown in a [previous preprint](https://psyarxiv.com/u8ekc/) while `dt_case_when()` is really new. Herein, I show more simple applications. 

The following data table will be used for the nesting/unnesting examples.

```{r, message = FALSE, warning = FALSE}
library(tidyfast)
library(data.table)
library(dplyr)       # to compare with case_when()

dt <- data.table(
   x = rnorm(1e5),
   y = runif(1e5),
   grp = sample(1L:3L, 1e5, replace = TRUE),
   nested1 = lapply(1:10, sample, 10, replace = TRUE),
   nested2 = lapply(c("thing1", "thing2"), sample, 10, replace = TRUE),
   id = 1:1e5)
```


We can nest this data using `dt_nest()`:

```{r}
nested <- dt_nest(dt, grp)
nested
```

We can also unnest this with `dt_unnest()`:

```{r}
dt_unnest(nested, col = data, id = grp)
```

When our list columns don't have data tables (as output from `dt_nest()`) we can use the `dt_unnest_vec()` function, that will unnest vectors.

```{r}
dt_unnest_vec(dt, 
              cols = list(nested1, nested2), 
              id = id, 
              name = c("nested1", "nested2"))
```

### If Else

Also, the new `dt_case_when()` function is built on the very fast `data.table::fiflese()` but has syntax like unto `dplyr::case_when()`. That is, it looks like:

```{r, eval = FALSE}
dt_case_when(condition1 ~ label1,
             condition2 ~ label2,
             ...)
```

To show that each method, `dt_case_when()`, `dplyr::case_when()`, and `data.table::fifelse()` produce the same result, consider the following example. 

```{r}
x <- rnorm(1e6)

medianx <- median(x)
x_cat <-
  dt_case_when(x < medianx ~ "low",
               x >= medianx ~ "high",
               is.na(x) ~ "unknown")
x_cat_dplyr <-
  case_when(x < medianx ~ "low",
            x >= medianx ~ "high",
            is.na(x) ~ "unknown")
x_cat_fif <-
  fifelse(x < medianx, "low",
  fifelse(x >= medianx, "high",
  fifelse(is.na(x), "unknown", NA_character_)))

identical(x_cat, x_cat_dplyr)
identical(x_cat, x_cat_fif)
```

Notably, `dt_case_when()` is very fast and memory efficient, given it is built on `data.table::fifelse()`.

```{r, echo = FALSE, warning = FALSE, message = FALSE, fig.width=6, fig.height=5, dpi=300}
marks <-
  bench::mark(dt_case_when(x < medianx ~ "low",
                           x >= medianx ~ "high",
                           is.na(x) ~ "unknown"),
              case_when(x < medianx ~ "low",
                        x >= medianx ~ "high",
                        is.na(x) ~ "unknown"),
              fifelse(x < medianx, "low",
              fifelse(x >= medianx, "high",
              fifelse(is.na(x), "unknown", NA_character_))),
              iterations = 50)

library(ggbeeswarm)  # for the speed comparison plot

marks$time %>% 
  setNames(c("dt_case_when", "case_when", "fifelse")) %>% 
  data.frame() %>% 
  tidyr::gather() %>% 
  mutate(value = as.numeric(value)) %>% 
  ggplot(aes(key, value, color = key)) +
  ggbeeswarm::geom_beeswarm() +
  labs(x = "",
       y = "Time (seconds)") +
  theme_minimal() +
  theme(panel.grid.major.x = element_blank(),
        legend.position = "none") +
  scale_color_viridis_d()

marks %>% 
  select(expression, median, mem_alloc) %>% 
  mutate(expression = c("dt_case_when", "case_when", "fifelse")) %>% 
  arrange(expression)
```


## Fill

A new function is `dt_fill()`, which fulfills the role of `tidyr::fill()` to fill in `NA` values with values around it (either the value above, below, or trying both). This currently relies on the efficient `C++` code from `tidyr` (`fillUp()` and `fillDown()`).

```{r}
x = 1:10
dt_with_nas <- data.table(
  x = x,
  y = shift(x),
  z = shift(x, -1L),
  a = sample(c(rep(NA, 10), x), 10),
  grp = sample(1:3, 10, replace = TRUE))

# All defaults
dt_fill(dt_with_nas)

# by id variable called `grp`
dt_fill(dt_with_nas, id = grp)

# both down and then up filling by group
dt_fill(dt_with_nas, id = grp, .direction = "downup")
```



## Note

Please note that the `tidyfast` project is released with a [Contributor Code of Conduct](.github/CODE_OF_CONDUCT.md). By contributing to this project, you agree to abide by its terms.

Also, `ggplot2`, `ggbeeswarm`, and `tidyr` were used herein for creating the plot.
